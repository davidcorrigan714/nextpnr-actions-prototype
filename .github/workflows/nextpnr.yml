name: nextpnr-ci

on:
  push:
    paths: 'nextpnr.yml'
jobs:
  next-pnr:
    name: Build nextpnr
    runs-on: windows-2019

    steps:
      - name: Setup msbuild
        uses: microsoft/setup-msbuild@v1
      
      - name: Print Testing
        run: |
          #echo $Env:Path
          #msbuild /?
          #echo $Env:BOOST_ROOT_1_72_0
          $Env:BOOST_ROOT = $Env:BOOST_ROOT_1_72_0
          dir $Env:BOOST_ROOT\lib
          dir $Env:BOOST_ROOT\libs
          dir $Env:BOOST_ROOT\include
          dir $Env:BOOST_ROOT\include\boost
          #dir $Env:BOOST_ROOT\boost
          dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild"
          dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\VS\lib\x64"

      - name: Add Boost to VS
        run: |
          $VS_Root = (C:\ProgramData\Chocolatey\bin\vswhere.exe -products * -requires Microsoft.Component.MSBuild -property installationPath -latest)+"\VC\Auxiliary\VS"
          Copy-Item -Recurse $Env:BOOST_ROOT_1_72_0\include\boost -Destination "$VS_Root\include"
          Copy-Item -Recurse $Env:BOOST_ROOT_1_72_0\lib\* -Destination "$VS_Root\lib\x64"
          echo "BOOST_LIBRARYDIR=$VS_Root\lib\x64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "BOOST_INCLUDEDIR=$VS_Root\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Checkout prjtrellis
        uses: actions/checkout@v2
        with:
          repository: YosysHQ/prjtrellis
          path: prjtrellis
          fetch-depth: 0

      - name: Build prjtrellis
        working-directory: prjtrellis\libtrellis\
        run: |
          echo $Env:BOOST_INCLUDEDIR
          echo $Env:BOOST_LIBRARYDIR
          cmake -DCMAKE_CXX_FLAGS='/D "BOOST_ALL_DYN_LINK"' .
          msbuild /t:Build /p:Configuration=Release libtrellis.sln
          
      #- name: Checkout nextpnr
      #  uses: actions/checkout@v2
      #  with:
      #    repository: YosysHQ/nextpnr
      #    submodules: recursive

      #- name: Checkout nextpnr
#        uses: actions/checkout@v2
 #       with:
  #        repository: YosysHQ/nextpnr
   #       submodules: recursive
        
#      - name: Checkout prjtrellis
 #       uses: actions/checkout@v2
  #      with:
   #       repository: YosysHQ/prjtrellis
      #
      #- name: Checkout yosys
#        uses: actions/checkout@v2
 #       with:
  #        repository: YosysHQ/yosys
      
   #   - name: Checkout icestorm
    #    uses: actions/checkout@v2
     #   with:
      #    repository: YosysHQ/icestorm
