name: nextpnr-ci

# Run this workflow every time a new commit pushed to your repository
on: push

jobs:
  # Set the job key. The key is displayed as the job name
  # when a job name is not provided
  next-pnr:
    # Name the Job
    name: Build nextpnr
    # Set the type of machine to run on
    runs-on: windows-2019

    steps:
      - name: Setup msbuild
        uses: microsoft/setup-msbuild@v1
      
      - name: Testing
        run: |
          #echo $Env:Path
          #msbuild /?
          #echo $Env:BOOST_ROOT_1_72_0
          $Env:BOOST_ROOT = $Env:BOOST_ROOT_1_72_0
          dir $Env:BOOST_ROOT\lib
          dir $Env:BOOST_ROOT\libs
          dir $Env:BOOST_ROOT\include
          dir $Env:BOOST_ROOT\include\boost
          #dir $Env:BOOST_ROOT\boost
          dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild"
          dir "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\VS\lib\x64"

      - name: Add Boost to VS
        run: |
          $VS_Root = (C:\ProgramData\Chocolatey\bin\vswhere.exe -products * -requires Microsoft.Component.MSBuild -property installationPath -latest)+"\VC\Auxiliary\VS"
          Copy-Item -Recurse $Env:BOOST_ROOT_1_72_0\include\boost -Destination "$VS_Root\include"
          Copy-Item -Recurse $Env:BOOST_ROOT_1_72_0\lib\* -Destination "$VS_Rootlib\lib\x64"
          dir "$VS_Rootlib\lib\x64"
          [Environment]::SetEnvironmentVariable("BOOST_INCLUDEDIR", "$VS_Root\include", [System.EnvironmentVariableTarget]::Machine)
          [Environment]::SetEnvironmentVariable("Boost_LIBRARYDIR", "$VS_Root\lib\x64", [System.EnvironmentVariableTarget]::Machine)
          $Env:BOOST_INCLUDEDIR = [System.Environment]::GetEnvironmentVariable("BOOST_INCLUDEDIR", "Machine")
          $Env:BOOST_LIBRARYDIR = [System.Environment]::GetEnvironmentVariable("BOOST_LIBRARYDIR", "Machine")
          dir "C:/Program Files (x86)/Microsoft Visual Studio/2019/Enterprise/VC/Auxiliary/VS/lib/x64"

      - name: Checkout prjtrellis
        uses: actions/checkout@v2
        with:
          repository: YosysHQ/prjtrellis
          path: prjtrellis

      - name: Testing
        working-directory: prjtrellis\libtrellis\
        run: |
          $Env:BOOST_INCLUDEDIR = [System.Environment]::GetEnvironmentVariable("BOOST_INCLUDEDIR", "Machine")
          $Env:BOOST_LIBRARYDIR = [System.Environment]::GetEnvironmentVariable("BOOST_LIBRARYDIR", "Machine")
          echo $Env:BOOST_INCLUDEDIR
          echo $Env:BOOST_LIBRARYDIR

          cmake -DCMAKE_CXX_FLAGS='/D "BOOST_ALL_DYN_LINK"' -DBoost_DEBUG=ON .
          msbuild /t:Build /p:Configuration=Release libtrellis.sln
          
      #- name: Checkout nextpnr
      #  uses: actions/checkout@v2
      #  with:
      #    repository: YosysHQ/nextpnr
      #    submodules: recursive

      #- name: Checkout nextpnr
#        uses: actions/checkout@v2
 #       with:
  #        repository: YosysHQ/nextpnr
   #       submodules: recursive
        
#      - name: Checkout prjtrellis
 #       uses: actions/checkout@v2
  #      with:
   #       repository: YosysHQ/prjtrellis
      #
      #- name: Checkout yosys
#        uses: actions/checkout@v2
 #       with:
  #        repository: YosysHQ/yosys
      
   #   - name: Checkout icestorm
    #    uses: actions/checkout@v2
     #   with:
      #    repository: YosysHQ/icestorm
